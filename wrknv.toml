[tasks]
typecheck = "mypy src/"
build = "uv build"

[tasks.test]
_default = "pytest"
parallel = "pytest -n auto"
verbose = "pytest -vvv"
unit = "pytest -m unit"
integration = "pytest -m integration"

[tasks.test.coverage]
_default = "pytest --cov=src --cov-report=html --cov-report=term-missing"
xml = "pytest --cov=src --cov-report=xml --cov-report=term"

[tasks.mutation]
_default = "mutmut run"
results = "mutmut results"
browse = "mutmut browse"
clean = "rm -rf .mutmut-cache html/"

[tasks.lint]
_default = "ruff check ."
fix = "ruff check . --fix"

[tasks.format]
_default = "ruff format ."
check = "ruff format . --check"

[tasks.quality]
_default = [
    "lint",
    "typecheck",
]
all = [
    "format.check",
    "lint",
    "typecheck",
    "test",
]

[tasks.pkg]
install = "uv pip install -e ."
uninstall = "uv pip uninstall -y $(grep '^name = ' pyproject.toml | cut -d'\"' -f2)"
lock = "uv lock"
version = "cat VERSION 2>/dev/null || grep '^version = ' pyproject.toml | cut -d'\"' -f2"

[tasks.clean]
run = "rm -rf build/ dist/ *.egg-info .pytest_cache .mypy_cache .ruff_cache .hypothesis htmlcov/ .coverage .mutmut-cache site/\nfind . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true\nfind . -type f -name '*.pyc' -delete 2>/dev/null || true\nfind . -type f -name '*.pyo' -delete 2>/dev/null || true\n"

[tasks.docs]
_default = "python scripts/docs_serve.py"
setup = "python -c \"from provide.foundry.config import extract_base_mkdocs; from pathlib import Path; extract_base_mkdocs(Path('.'))\""
build = "python scripts/docs_preflight.py && mkdocs build"
clean = "rm -rf site .provide"
preflight = "python scripts/docs_preflight.py"
validate = "python scripts/docs_validate.py"

[tasks.docs.serve]
run = "python scripts/docs_serve.py"
timeout = 604800.0

[tasks.docs.links]
_default = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
check = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
local = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
external = "lychee --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md'"

[tasks.dev]
setup = "uv sync"
test = "pytest -n auto"
check = "ruff format . && ruff check . && mypy src/"

[tasks.ci]
_default = [
    "quality",
    "test",
    "build",
]
test = [
    "test.parallel",
    "test.coverage",
]
quality = [
    "format.check",
    "lint",
    "typecheck",
]

[tasks.setup]
_default = "uv sync"
pre-commit = "if ! command -v pre-commit >/dev/null 2>&1; then\n  echo \"Installing pre-commit...\"\n  uv pip install pre-commit\nfi\nif [ ! -f .pre-commit-config.yaml ]; then\n  echo \"Installing standard pre-commit config...\"\n  if [ -f ../ci-tooling/configs/pre-commit-config.yaml ]; then\n    cp ../ci-tooling/configs/pre-commit-config.yaml .pre-commit-config.yaml\n  else\n    echo \"Warning: ci-tooling/configs/pre-commit-config.yaml not found\"\n    echo \"Please ensure ci-tooling is cloned at ../ci-tooling\"\n    exit 1\n  fi\nfi\npre-commit install\npre-commit install --hook-type commit-msg\necho \"âœ“ Pre-commit hooks installed\"\n"
