# --- Virtual Environment ---
Write-Header "üêç Setting Up Virtual Environment"
Write-Host "Directory: $VenvDir"

# Check for existing venv - handle cross-platform paths
if ($IsWindows) {
    $VenvExists = (Test-Path $VenvDir) -and (Test-Path "$VenvDir/Scripts/activate.ps1") -and (Test-Path "$VenvDir/Scripts/python.exe")
} else {
    $VenvExists = (Test-Path $VenvDir) -and (Test-Path "$VenvDir/bin/activate.ps1") -and (Test-Path "$VenvDir/bin/python")
}

if ($VenvExists) {
    Write-Success "Virtual environment exists"
} else {
    Write-Host "Creating virtual environment..." -NoNewline
    try {
        & uv venv $VenvDir
        Write-Success " Virtual environment created"
    }
    catch {
        Write-Error " Virtual environment creation failed: $_"
        exit 1
    }
}

# Activate virtual environment - handle cross-platform paths
if ($IsWindows) {
    $ActivateScript = Join-Path $VenvDir "Scripts/Activate.ps1"
} else {
    # On macOS/Linux, activation script is in bin directory with lowercase name
    $ActivateScript = Join-Path $VenvDir "bin/activate.ps1"
}

if (Test-Path $ActivateScript) {
    & $ActivateScript
    $env:VIRTUAL_ENV = Join-Path (Get-Location) $VenvDir
} else {
    Write-Error "Could not find activation script at $ActivateScript"
    Write-Host "Note: Virtual environment created but activation failed."
    Write-Host "For macOS/Linux, you may need to use: source $VenvDir/bin/activate"
    exit 1
}